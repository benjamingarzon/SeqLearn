---
title: "R Notebook"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

# open data
```{r}
rm(list=ls())

library(ggplot2)
library(reshape2)
library(dplyr)

trialsfile = paste0('../data/archive/trials_table-20190213_1119-Lundpilot2db.csv')
trials.table = unique(read.table(trialsfile, sep =';', header = T,quote = "")[-1])

maxy = 4500 
miny = 500 

# analyze only these
group = c("lup2s002", "lup2s003", "lup2s004", "lup2s005", "lup2s006", "lup2s007")

trials.table = subset(trials.table, username %in% group)

```


Performance
```{r fig.width=14, fig.asp=0.4}

ok_trials = subset(trials.table, accuracy == 1)
unpaced_trials = subset(trials.table, paced == 0 & trial_type != "missed")
paced_trials = subset(trials.table, paced == 1 & trial_type != "missed")
ok_unpaced_trials = subset(unpaced_trials, accuracy == 1)
ok_paced_trials = subset(paced_trials, accuracy == 1)
                      
plot.MT = ggplot(ok_unpaced_trials, aes(x = trial, y = MT, col = as.factor(seq_train), group = true_sequence)) + geom_line(lwd=1) + geom_point() + ylim(miny, maxy) + facet_grid( username ~ sess_num) + theme(legend.position="bottom") + theme_bw()

plot.MT.paced = ggplot(ok_paced_trials, aes(x = trial, y = MT, col = as.factor(seq_train), group = true_sequence)) + geom_line(lwd=1) + geom_point() + ylim(miny, maxy) + facet_grid( username ~ sess_num) + theme(legend.position="none") + theme_bw()

plot.MT.paced.hist = ggplot(ok_paced_trials, aes(x = MT, col = as.factor(seq_train), group = true_sequence)) + geom_histogram(bins = 50) + facet_grid(  username ~ . ) + theme(legend.position="none") + theme_bw()
 
print(plot.MT)
print(plot.MT.paced)
print(plot.MT.paced.hist)

```



Mean performance
```{r fig.width=25, fig.asp=0.6}

# consider only last trials 
last_trials = subset(unpaced_trials, trial > 5) %>% 
  group_by(username, sess_num, true_sequence, seq_train) %>% 
  summarise(meanMT = mean(MT), sdMT = sd(MT))

plot.meanMT = ggplot(last_trials, aes(x = sess_num, y = meanMT, group = true_sequence, col = as.factor(seq_train))) + geom_line(lwd=1) + geom_point() + facet_grid( seq_train ~ username ) + theme(legend.position="bottom") + theme_bw()

print(plot.meanMT)

# aggregate within participant and compare participants

last_trials.user = last_trials %>% 
  group_by(username, sess_num, seq_train) %>% 
  summarise(meanMT = mean(meanMT), sdMT = mean(sdMT))

plot.meanMT.user = ggplot(last_trials.user, aes(x = sess_num, y = meanMT, col = username, lty = as.factor(seq_train), shape = as.factor(seq_train))) + geom_line(lwd=1) + geom_point(size = 3) + facet_grid( .~ seq_train) + theme_bw()

print(plot.meanMT.user)

# aggregate within sequence 
last_trials.sequence = last_trials %>% 
  group_by(true_sequence, username, sess_num, seq_train) %>% 
  summarise(meanMT = mean(meanMT), sdMT = mean(sdMT))

plot.meanMT.sequence = ggplot(last_trials.sequence, aes(x = sess_num, y = meanMT, group = username, lty = as.factor(seq_train), col = username)) + geom_line(lwd=1) + geom_point(size = 3) + facet_grid( seq_train ~ true_sequence ) + theme_bw() + theme(legend.position="bottom") 

print(plot.meanMT.sequence)


```

Wrong trials 

```{r fig.width=11, fig.asp=0.8}

unpaced_trials.wrong = unpaced_trials %>% 
  group_by(username, sess_num, true_sequence, seq_train) %>% 
  summarise(wrong_trials = sum(accuracy < 1))

paced_trials.wrong = paced_trials %>% 
  group_by(username, sess_num, true_sequence, seq_train) %>% 
  summarise(wrong_trials = sum(accuracy < 1))

plot.unpaced.wrong = ggplot(unpaced_trials.wrong, aes(x = sess_num, y = wrong_trials, col = true_sequence, group = true_sequence, lty = as.factor(seq_train))) + geom_line(lwd=1) + geom_point() + facet_grid( username ~ .) + theme(legend.position="none") + theme_bw()

plot.paced.wrong = ggplot(paced_trials.wrong, aes(x = sess_num, y = wrong_trials, col = true_sequence, group = true_sequence, lty = as.factor(seq_train))) + geom_line(lwd=1) + geom_point() + facet_grid( username ~ .) + theme(legend.position="none") + theme_bw()

print(plot.unpaced.wrong)
print(plot.paced.wrong)

```


Missed trials 

```{r fig.width=11, fig.asp=0.8}

unpaced_trials.missed = subset(trials.table, paced == 0 & trial_type == "missed") %>% 
  group_by(username, sess_num, true_sequence, seq_train) %>% 
  summarise(missed_trials = n())

paced_trials.missed = subset(trials.table, paced == 1 & trial_type == "missed") %>% 
  group_by(username, sess_num, true_sequence, seq_train) %>% 
  summarise(missed_trials = n())

plot.unpaced.missed = ggplot(unpaced_trials.missed, aes(x = sess_num, y = missed_trials, col = true_sequence, group = true_sequence, lty = as.factor(seq_train))) + geom_line(lwd=1) + geom_point() + facet_grid( username ~ .) + theme(legend.position="none")

plot.paced.missed = ggplot(paced_trials.missed, aes(x = sess_num, y = missed_trials, col = true_sequence, group = true_sequence, lty = as.factor(seq_train))) + geom_line(lwd=1) + geom_point() + facet_grid( username ~ .) + theme(legend.position="none")

print(plot.unpaced.missed)
print(plot.paced.missed)

```


Session duration
```{r fig.width=11, fig.asp=0.8}
plot.duration = ggplot(trials.table, aes(x = sess_num, y = global_clock/60, col = username, group = username)) + 
  stat_summary(fun.y = max, geom = "line", lwd = 1) +  stat_summary(fun.y = max, geom = "point") + ylab("Session duration")

print(plot.duration)

```


Dates and times
```{r fig.width=11, fig.asp=0.8}

trials.times = trials.table %>% mutate(sess_date = as.Date(sess_date), sess_time = as.POSIXct(sess_time, format="%H:%M:%S")) %>% group_by(username, sess_num, sess_date, sess_time, sess_type) %>% sample_n(1) 
#kip1 = grep('kip1', trials.times$username)
#trials.times =trials.times[kip1, ]
plot.dates = ggplot(trials.times, aes(x = sess_num, y = sess_date, col = username, group = username)) + geom_line() + geom_point() + xlab("Session number") + ylab("Session date") + scale_y_date()

print(plot.dates)

table(trials.times$username)

plot.times = ggplot(trials.times, aes(x = sess_num, y = sess_time)) + geom_line() + geom_point() + xlab("Session number") + ylab("Session time") + facet_grid( . ~ username)
print(plot.times)

```


